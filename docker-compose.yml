services:
  minecraft-server:
    build:
      context: .
      dockerfile: containers/minecraft/Dockerfile
    container_name: minecraft-server
    restart: unless-stopped

    networks:
      minecraft-network:
        ipv4_address: 172.25.0.10

    ports:
      - "25565:25565"  # Minecraft server port
      - "24454:24454"  # Voice chat mod port
      # ttyd terminal (port 7681) is proxied through nginx at /server-terminal

    volumes:
      # Mount entire minecraft folder - everything runs from here
      - ./containers/minecraft:/minecraft

      # Mount libraries folder (persistent across restarts)
      - minecraft-libraries:/minecraft/libraries

    environment:
      # Server site address for internal communication
      - SERVER_SITE_HOST=server-site
      - SERVER_SITE_IP=172.25.0.20

      # Memory settings (adjust both to allocate RAM to Minecraft server)
      # Important: Set MAX_RAM and MIN_RAM to the same value for best performance
      # Container memory limit below should be ~1.5-2GB more than these values
      - MAX_RAM=4G
      - MIN_RAM=7G

      # Java options
      - JAVA_TOOL_OPTIONS=-Dfile.encoding=UTF-8

      # Server Properties (Required)
      # ONLINE_MODE: true for authentication, false for cracked servers
      - ONLINE_MODE=true
      # LEVEL_NAME is not needed - it's already set to "world" in server.properties
      # and should always remain "world" (the container's internal folder name)

      # Optional Server Properties (uncomment to override defaults)
      # If not set, uses values from minecraft/server.properties
      # - MOTD=A Minecraft Server
      # - MAX_PLAYERS=20
      # - DIFFICULTY=normal
      # - GAMEMODE=survival
      # - PVP=true
      # - HARDCORE=false
      # - WHITE_LIST=false
      # - LEVEL_SEED=
      # - VIEW_DISTANCE=10
      # - SIMULATION_DISTANCE=10
      # - SPAWN_PROTECTION=16
      # - ALLOW_NETHER=true
      # - ALLOW_FLIGHT=false
      # - ENABLE_COMMAND_BLOCK=false
      # - SPAWN_ANIMALS=true
      # - SPAWN_MONSTERS=true
      # - SPAWN_NPCS=true

    stdin_open: true
    tty: true

    # Resource limits
    # Container memory should be MAX_RAM + ~1.5-2GB for JVM overhead
    deploy:
      resources:
        limits:
          memory: 6G
        reservations:
          memory: 4G

  server-site:
    build:
      context: .
      dockerfile: containers/server-site/Dockerfile
    container_name: minecraft-server-site
    restart: unless-stopped

    networks:
      minecraft-network:
        ipv4_address: 172.25.0.20

    environment:
      # Minecraft server address for internal communication
      - MINECRAFT_SERVER_HOST=minecraft-server
      - MINECRAFT_SERVER_IP=172.25.0.10
      - MINECRAFT_SERVER_TERMINAL_PORT=7681

    ports:
      - "80:80"        # Static site on port 80

    volumes:
      # Mount data folder for mods.zip download (from minecraft folder)
      - ./containers/minecraft/data:/usr/share/nginx/html/data:ro

    depends_on:
      - minecraft-server

    # Resource limits (static site needs minimal memory)
    deploy:
      resources:
        limits:
          memory: 128M
        reservations:
          memory: 64M

volumes:
  minecraft-libraries:
    driver: local

networks:
  minecraft-network:
    driver: bridge
    internal: false  # Allows outbound connections for authentication/updates
    ipam:
      driver: default
      config:
        - subnet: 172.25.0.0/16
          gateway: 172.25.0.1
